---
title: "ensembl_cardiac_diseases_panel_20200715"
output: 
  pdf_document: default
  github_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
suppressMessages(library(knitr))
suppressMessages(library(data.table))
suppressMessages(library(tidyverse))
suppressMessages(library(qvalue))

outlier <- function (x) {
  IQR <- quantile(x)[[4]] - quantile(x)[[2]]
  low <- quantile(x)[[2]] - 1.5*IQR
  high <- quantile(x)[[4]] + 1.5*IQR
  out_val <- x[x < low | x > high]
  return(out_val)
}
```

## 1. Cohort information

```{r sample info, echo=FALSE}
prepheno <- read.table('../input/prepheno.csv',header=T,sep='\t')
to_include <- read.table('../../../genom_polaka/SAMPLES_TO_INCLUDE_210519.txt',sep='\t')

pheno <- prepheno %>% filter(prepheno$Individual_ID %in% to_include$V1)
pheno$Covid_severity <- ifelse(pheno$Covid_severity == 'COV_SEVERE', 1,0) 
  pheno%>%
  ggplot(aes(factor(Covid_severity))) + geom_bar(fill=c('#27384A','#48C095'),width=0.5) +
  geom_text(stat='count', aes(label=..count..), vjust=-1) + 
  ylim(c(0,1000)) + 
  ylab('Number of individuals') +
  xlab('Covid severity') +
  scale_x_discrete(labels=c('Control','Severe')) + 
  ggtitle(paste('Distribution of covid severity in cohort of',pheno %>% nrow(), 'individuals',sep = ' ')) +
  theme_classic() +  
  theme(plot.title = element_text(hjust = 0.5))
```

Control label include mild benign and resistant response to COVID-19 infection

\newpage
## 2. Results

Association study was performed by comparison of allele counts in cases 
and controls with Chi-square test. Significance of variants is expressed in form of q-values 
which are FDR adjusted p-values.


```{r af plot, echo=FALSE}
group.colors <- c(significant = "#BC0020", `not significant` ="#48C095")

cardiac_fish <- fread('../output/CARDIAC.assoc') 
qobj <- qvalue(p = cardiac_fish$P)
cardiac_fish$q <- qobj$qvalues
cardiac_fish$significance <- ifelse(cardiac_fish$q < 0.1,'significant','not significant') 
cardiac_fish <- cardiac_fish %>% arrange(q)

vep_pos <- cardiac_fish %>% select(CHR,BP)
vep_pos$POS <- paste('chr',vep_pos$CHR,sep='')
vep_pos$POS <- paste(vep_pos$POS, vep_pos$BP,sep=':')
write.table(vep_pos$POS,'../input/cardiac_pos.tsv',quote = F,
             col.names = F,
             row.names = F,
             sep='\t')

cardiac_fish %>% na.omit() %>%
  ggplot(aes(x=F_U,y=F_A,col=significance)) + 
  geom_point(alpha=0.5) +
  ylab('Frequency of allele in cases') +
  xlab('Frequency of allele in controls') +
  ggtitle('Minor allele frequency in cases and controls') + 
  theme_classic() +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust=0.5)) +
  scale_color_manual(values=group.colors)
  

```





```{r, echo =FALSE}
vep <- read.csv('../input/cardiac_panel.vep.tsv',header=T,sep='\t')
vep_cardiac <- cardiac_fish %>% filter(significance=='significant') %>%
  select(SNP) %>% left_join(vep, by = c('SNP'='X.Uploaded_variation')) %>%
  right_join(cardiac_fish, by = 'SNP')  %>%
  select(SNP,Existing_variation,SYMBOL,A1,A2, CLIN_SIG, q,P,F_A,F_U,OR,L95,U95,significance) %>% 
  na.omit() %>% 
  rename('qvalue' = q, 'case_frequency' = F_A, 'ctrl_frequency'=F_U) %>% 
  arrange(qvalue)
```


\newpage

```{r OR plot, echo=FALSE}
vep_cardiac %>% filter(significance == 'significant') %>% 
  #left_join(vep_cardiac, by = 'SNP') %>% na.omit() %>%
  ggplot(aes(y=reorder(SNP,-OR),x=OR)) + 
  geom_point(col="#48C095") +
  xlim(c(0,30)) +
  geom_text(aes(label=SYMBOL),hjust=-0.2, vjust=0.2) +
  geom_vline(xintercept = 1,linetype='dashed',col="#BC0020") +
  ylab('SNP') +
  xlab('Odds ratio') +
  ggtitle('Estimated odds ratio (OR) of minor allele occurence', 
          subtitle = 'Red dashed line: OR = 1.0') +
  theme_classic() +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust=0.5))
 

```


```{r, echo=FALSE}
kable(vep_cardiac %>%
        #rename('rsid'=Existing_variation) %>% 
        select(SNP,SYMBOL,
               A2,A1,case_frequency,ctrl_frequency,qvalue,OR) %>%
        arrange(qvalue),
      caption = "Variants with q-value < 0.1"
        )

```